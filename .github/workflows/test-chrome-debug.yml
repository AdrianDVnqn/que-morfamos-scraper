name: Test Chrome Debug

on:
  workflow_dispatch:

jobs:
  test-chrome:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Instalar Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Instalar dependencias
        run: |
          pip install selenium webdriver-manager beautifulsoup4
      
      - name: Test con URL real de restaurante
        env:
          PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          # Descargar lugares_validados.csv
          git clone "https://x-access-token:${PRIVATE_REPO_TOKEN}@github.com/AdrianDVnqn/que-morfamos.git" private-repo
          cp private-repo/data/lugares_validados.csv . 2>/dev/null || echo "No hay CSV"
          
          python -c "
          from selenium import webdriver
          from selenium.webdriver.chrome.service import Service
          from webdriver_manager.chrome import ChromeDriverManager
          import csv
          import time

          # Leer primera URL del CSV
          url = None
          try:
              with open('lugares_validados.csv', 'r', encoding='utf-8') as f:
                  reader = csv.DictReader(f)
                  for row in reader:
                      url = row.get('link')
                      nombre = row.get('nombre', 'Desconocido')
                      break
          except Exception as e:
              print(f'Error leyendo CSV: {e}')
              url = 'https://www.google.com/maps'
              nombre = 'Fallback'
          
          print(f'=== Probando con: {nombre} ===')
          print(f'URL: {url[:80]}...')
          
          options = webdriver.ChromeOptions()
          options.add_argument('--headless')
          options.add_argument('--no-sandbox')
          options.add_argument('--disable-dev-shm-usage')
          options.add_argument('--disable-gpu')
          options.add_argument('--window-size=1920,1080')
          
          try:
              print('Creando driver...')
              driver = webdriver.Chrome(
                  service=Service(ChromeDriverManager().install()), 
                  options=options
              )
              driver.set_page_load_timeout(60)
              print('✓ Driver creado')
              
              print('Navegando a URL...')
              driver.get(url)
              print(f'✓ Navegación exitosa')
              print(f'Title: {driver.title}')
              
              print('Esperando 5 segundos...')
              time.sleep(5)
              
              print(f'Page source length: {len(driver.page_source)}')
              
              driver.quit()
              print('✓ Test PASÓ')
              
          except Exception as e:
              print(f'❌ ERROR: {e}')
              import traceback
              traceback.print_exc()
          "
