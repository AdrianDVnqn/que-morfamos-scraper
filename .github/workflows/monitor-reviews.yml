name: Monitoreo de Reviews

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 8:00 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  monitor-growth:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Instalar Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Instalar dependencias
        run: |
          pip install selenium webdriver-manager psycopg2-binary
      
      - name: Ejecutar Monitor
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: python monitor_reviews.py > run.log 2>&1

      - name: Subir Log de EjecuciÃ³n
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: log-monitor-reviews
          path: run.log
      
      - name: Notificar a Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python -c "
          import os, requests, datetime
          
          webhook = os.environ.get('DISCORD_WEBHOOK_URL')
          if webhook:
              try:
                  content = 'Revisar Log Adjunto.'
                  # Intentar leer del log si no es muy grande o buscar resumen
                  if os.path.exists('run.log'):
                      with open('run.log', 'r', encoding='utf-8', errors='ignore') as f:
                          full_log = f.read()
                          # Extraer resumen simple si existe
                          lines = [l for l in full_log.splitlines() if 'Crecimiento total' in l]
                          if lines:
                              content = lines[-1]
                  
                  msg = f'''ðŸ“Š **Reporte Diario de Reviews**
                  ðŸ“… {datetime.datetime.now().strftime('%d/%m/%Y')}
                  
                  {content}
                  
                  [Log completo disponible en GitHub Actions artifacts]
                  '''
                  
                  requests.post(webhook, json={'embeds': [{'description': msg, 'color': 0x3498db}]})
              except Exception as e:
                  print(f'Error enviando notif: {e}')
          "
