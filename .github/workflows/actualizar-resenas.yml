name: Actualizaci贸n Diaria de Rese帽as

on:
  schedule:
    # Ejecutar todos los d铆as a las 22:00 HS Argentina (01:00 UTC)
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      full_regeneration:
        description: 'Regeneraci贸n COMPLETA de embeddings (costoso)'
        required: false
        type: boolean
        default: false
      resume:
        description: 'RESUMIR ejecuci贸n fallida (saltar ya procesados)'
        required: false
        type: boolean
        default: false

jobs:
  monitor-growth:
    runs-on: ubuntu-latest
    timeout-minutes: 320
    
    steps:
      - name: Checkout c贸digo
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Instalar Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Instalar dependencias
        run: |
          pip install selenium webdriver-manager psycopg2-binary requests beautifulsoup4 pandas langchain-openai langchain-postgres sqlalchemy
      
      - name: Ejecutar Monitor
        id: monitor
        # Solo correr el monitor si NO es una regeneraci贸n completa forzada
        if: github.event.inputs.full_regeneration != 'true'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python monitor_reviews.py 2>&1 | tee run.log
          
          # L贸gica original de outputs
          if grep -q "CONTINUE_NEEDED" run.log; then
            echo "continue=true" >> $GITHUB_OUTPUT
          else
            echo "continue=false" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "Rese帽as nuevas: [1-9]" run.log; then
            echo "has_new_reviews=true" >> $GITHUB_OUTPUT
          else
            echo "has_new_reviews=false" >> $GITHUB_OUTPUT
          fi


      
      - name: Regenerar Embeddings
        # Correr si:
        # 1. Es regeneraci贸n forzada (full_regeneration == true)
        # 2. O si el monitor detect贸 nuevas reviews (has_new_reviews == true)
        if: success() && (github.event.inputs.full_regeneration == 'true' || steps.monitor.outputs.has_new_reviews == 'true')
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          if [ "${{ github.event.inputs.full_regeneration }}" == "true" ]; then
            if [ "${{ github.event.inputs.resume }}" == "true" ]; then
              echo " MODO FULL + RESUME: Continuando regeneraci贸n..."
              python regenerate_embeddings.py --full --resume 2>&1 | tee -a run.log
            else
              echo " MODO FULL ACTIVADO: Regenerando TODO..."
              python regenerate_embeddings.py --full 2>&1 | tee -a run.log
            fi
          else
            echo " Regenerando embeddings inteligentemente (incremental)..."
            python regenerate_embeddings.py 2>&1 | tee -a run.log
          fi
      
      - name: Notificar a Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python notificador.py --mode monitor_reviews --file run.log

      - name: Subir Log de Ejecuci贸n
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: log-monitor-reviews
          path: run.log
      
      - name: Re-trigger si hay pendientes
        if: steps.monitor.outputs.continue == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo " Hay lugares pendientes, reiniciando workflow..."
          gh workflow run actualizar-resenas.yml
